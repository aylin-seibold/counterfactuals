---
title: "Counterfactual Explanations for binary credit risk classification with MOC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{credit-example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  out.width = "100%"
)
```

In this showcase, we demonstrate the application of `MOC` in a binary credit risk classification problem.

# Data: German Credit Dataset

For this we use the `rchallenge::german` dataset, which contains 1000 observations with 20 features and the binary target
variable `credit_risk` with possible values `good` and `bad`.

```{r}
data("german", package = "rchallenge")
```

Add latex table with variable description

First we train a randomForest and all data expect one row, which we use a "new observation" for which we want to find
counterfactual explanations later.

```{r setup, message=FALSE}
library(counterfactuals)
library(randomForest)
library(iml)
idx_x_interest = 998L
x_interest = german[idx_x_interest, ]
train_data = german[-idx_x_interest, ]
rf = randomForest(credit_risk ~ ., data = german, ntree = 500L)
```

# Using the iml Predictor() container

```{r}
predictor_german = Predictor$new(rf, data = train_data, y = "credit_risk", type = "prob")
predictor_german$predict(x_interest)
```

# Finding counterfactuals

Setup of MOC
```{r}
set.seed(5687454)
mocc = MOCClassif$new(predictor_german, n_generations = 10L, fixed_features = c("personal_status_sex", "age", "purpose"), 
                      epsilon = 0.1)
```
Run the method
```{r, results='hide'}
set.seed(5687454)
cfactuals = mocc$find_counterfactuals(x_interest, desired_class = "good", desired_prob = c(0.7, 1))
```

# Quality checks
```{r}
mocc$plot_statistics()
```

```{r}
mocc$plot_search()
```

# Results

```{r}
cfactuals$data
```

```{r}
cfactuals$plot_freq_of_feature_changes(subset_zero = TRUE)
```






